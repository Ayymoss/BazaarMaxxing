@using BazaarCompanionWeb.Entities
@rendermode InteractiveServer

<div class="relative inline-block text-left" tabindex="0">
    <button type="button" 
            class="flex items-center gap-2 rounded-md border border-slate-700/50 bg-slate-800/40 pl-2.5 pr-8 py-0.5 text-[10px] font-semibold text-slate-300 shadow-sm transition-all hover:border-slate-500 hover:bg-slate-700/60 focus:border-blue-500/50 focus:outline-none focus:ring-1 focus:ring-blue-500/30 backdrop-blur-sm"
            @onclick="Toggle"
            @onclick:stopPropagation>
        @GetShortName(SelectedInterval)
        <i class="ph ph-caret-down absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-500 text-[10px] transition-transform @(_isOpen ? "rotate-180" : "")"></i>
    </button>

    @if (_isOpen)
    {
        @* Transparent overlay to catch clicks outside *@
        <div class="fixed inset-0 z-40" @onclick="Close"></div>

        <div class="absolute right-0 z-50 mt-1 w-24 origin-top-right rounded-lg border border-slate-700/60 bg-slate-900/90 p-1 shadow-xl backdrop-blur-xl animate-in fade-in zoom-in-95 duration-100">
            <div class="flex flex-col gap-0.5">
                @foreach (CandleInterval interval in Enum.GetValues<CandleInterval>().OrderBy(x => (int)x))
                {
                    <button type="button"
                            class="flex items-center justify-between rounded-md px-2 py-1.5 text-left text-[10px] font-bold transition-colors @(SelectedInterval == interval ? "bg-blue-500/20 text-blue-400" : "text-slate-400 hover:bg-slate-800 hover:text-slate-200")"
                            @onclick="() => SelectInterval(interval)"
                            @onclick:stopPropagation>
                        @GetShortName(interval)
                        @if (SelectedInterval == interval)
                        {
                            <i class="ph ph-check text-[8px]"></i>
                        }
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public CandleInterval SelectedInterval { get; set; }
    [Parameter] public EventCallback<CandleInterval> OnIntervalChanged { get; set; }

    private bool _isOpen;

    private void Toggle() => _isOpen = !_isOpen;

    private async Task SelectInterval(CandleInterval interval)
    {
        _isOpen = false;
        if (SelectedInterval != interval)
        {
            SelectedInterval = interval;
            await OnIntervalChanged.InvokeAsync(interval);
        }
        StateHasChanged();
    }

    private void Close()
    {
        _isOpen = false;
        StateHasChanged();
    }

    private static string GetShortName(CandleInterval interval) => interval switch
    {
        CandleInterval.FiveMinute => "5M",
        CandleInterval.FifteenMinute => "15M",
        CandleInterval.OneHour => "1H",
        CandleInterval.FourHour => "4H",
        CandleInterval.Daily => "1D",
        CandleInterval.Weekly => "1W",
        _ => interval.ToString()
    };
}
