@page "/analytics"
@using BazaarCompanionWeb.Components.Pages.Analytics
@using BazaarCompanionWeb.Dtos
@using CorrelationMatrixDto = BazaarCompanionWeb.Dtos.CorrelationMatrix
@using BazaarCompanionWeb.Services
@rendermode InteractiveServer

<PageTitle>Market Analytics - Bazaar Maxxing</PageTitle>

<div class="flex flex-col gap-4 w-full max-w-[1920px] mx-auto animate-in fade-in slide-in-from-bottom-2 duration-500">
    <!-- Header -->
    <div class="flex flex-col gap-3 rounded-xl border border-slate-700/50 bg-slate-900/60 px-4 py-3 shadow-lg backdrop-blur-xl">
        <div class="flex items-center gap-3">
            <h1 class="text-2xl font-bold tracking-tight text-white">
                <span class="bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Market Analytics Dashboard</span>
            </h1>
            <div class="h-6 w-px bg-slate-700"></div>
            <div class="flex items-center gap-1.5 text-xs font-medium text-slate-400">
                <span class="flex h-2 w-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                @if (_lastUpdate != null)
                {
                    <span>Updated @_lastUpdate.Value.ToString("HH:mm:ss")</span>
                }
                else
                {
                    <span>Loading...</span>
                }
            </div>
        </div>
    </div>

    @if (_loading)
    {
        <div class="flex flex-col items-center justify-center py-20">
            <div class="h-1 w-32 overflow-hidden rounded-full bg-slate-800">
                <div class="h-full w-full origin-left animate-[indeterminate_1s_infinite_linear] bg-blue-500"></div>
            </div>
            <p class="mt-3 text-xs text-slate-500 animate-pulse">Loading market analytics...</p>
        </div>
    }
    else
    {
        <!-- Market Metrics Panel -->
        <MarketMetricsPanel Metrics="@_metrics" />

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Correlation Matrix -->
            <div class="lg:col-span-1">
                <Components.Pages.Analytics.CorrelationMatrix CorrelationData="@_correlationMatrix" />
            </div>

            <!-- Trend Analysis -->
            <div class="lg:col-span-1">
                <TrendAnalysis TrendingProducts="@_trendingProducts" HeatmapData="@_heatmapData" />
            </div>
        </div>
    }
</div>

@code {
    [Inject] private MarketAnalyticsService MarketAnalyticsService { get; set; } = null!;

    private bool _loading = true;
    private MarketMetrics? _metrics;
    private CorrelationMatrixDto? _correlationMatrix;
    private List<ProductTrend> _trendingProducts = new();
    private MarketHeatmapData? _heatmapData;
    private DateTime? _lastUpdate;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _metrics = await MarketAnalyticsService.GetMarketMetricsAsync();
            _correlationMatrix = await MarketAnalyticsService.GetCorrelationMatrixAsync();
            _trendingProducts = await MarketAnalyticsService.GetTrendingProductsAsync(10);
            _heatmapData = await MarketAnalyticsService.GetMarketHeatmapAsync();
            _lastUpdate = DateTime.Now;
        }
        catch (Exception ex)
        {
            // Log error - in production, show user-friendly error message
            Console.WriteLine($"Error loading market analytics: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }
}
