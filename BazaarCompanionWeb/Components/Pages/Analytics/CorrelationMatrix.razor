@using BazaarCompanionWeb.Dtos
@using CorrelationMatrixDto = BazaarCompanionWeb.Dtos.CorrelationMatrix
@using Microsoft.AspNetCore.Components

<div class="rounded-xl border border-slate-700/50 bg-slate-900/60 shadow-xl backdrop-blur-xl p-4">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-white flex items-center gap-2">
            <i class="ph ph-graph text-blue-400"></i>
            Product Correlation Matrix
        </h3>
        <div class="text-xs text-slate-500">
                @if (CorrelationData != null)
                {
                    <span>Calculated @CorrelationData.CalculatedAt.ToString("HH:mm:ss")</span>
                }
        </div>
    </div>

    @if (CorrelationData == null || !CorrelationData.ProductKeys.Any())
    {
        <div class="flex flex-col items-center justify-center py-12 text-slate-500">
            <i class="ph ph-chart-line text-4xl mb-2"></i>
            <p class="text-sm">No correlation data available</p>
        </div>
    }
    else
    {
        <div class="overflow-x-auto">
            <div class="text-xs text-slate-400 mb-2">
                Showing top @CorrelationData.ProductKeys.Count products by volume. 
                Click a cell to see correlation strength.
            </div>
            
            <!-- Correlation Legend -->
            <div class="flex items-center gap-4 mb-3 text-xs">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-red-500/80"></div>
                    <span class="text-slate-400">Strong Negative (-1.0 to -0.7)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-slate-700"></div>
                    <span class="text-slate-400">Weak (-0.7 to 0.7)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-green-500/80"></div>
                    <span class="text-slate-400">Strong Positive (0.7 to 1.0)</span>
                </div>
            </div>

            <!-- Matrix Grid -->
            <div class="grid gap-1" style="grid-template-columns: repeat(@(CorrelationData.ProductKeys.Count + 1), minmax(80px, 1fr));">
                <!-- Header row -->
                <div class="text-[10px] font-semibold text-slate-500 p-1"></div>
                @foreach (var productKey in CorrelationData.ProductKeys.Take(20)) // Limit to 20 for performance
                {
                    var index = CorrelationData.ProductKeys.IndexOf(productKey);
                    var name = index < CorrelationData.ProductNames.Count 
                        ? CorrelationData.ProductNames[index] 
                        : productKey;
                    <div class="text-[10px] font-semibold text-slate-500 p-1 truncate" title="@name">
                        @name.Substring(0, Math.Min(8, name.Length))
                    </div>
                }

                <!-- Data rows -->
                @foreach (var productKey in CorrelationData.ProductKeys.Take(20))
                {
                    var rowIndex = CorrelationData.ProductKeys.IndexOf(productKey);
                    var rowName = rowIndex < CorrelationData.ProductNames.Count 
                        ? CorrelationData.ProductNames[rowIndex] 
                        : productKey;
                    
                    <!-- Row header -->
                    <div class="text-[10px] font-semibold text-slate-500 p-1 truncate" title="@rowName">
                        @rowName.Substring(0, Math.Min(8, rowName.Length))
                    </div>

                    <!-- Correlation cells -->
                    @foreach (var colKey in CorrelationData.ProductKeys.Take(20))
                    {
                        var correlation = CorrelationData.Matrix.ContainsKey(productKey) && 
                                         CorrelationData.Matrix[productKey].ContainsKey(colKey)
                            ? CorrelationData.Matrix[productKey][colKey]
                            : 0.0;

                        var absCorrelation = Math.Abs(correlation);
                        var colorIntensity = (int)(absCorrelation * 255);
                        var bgColor = correlation > 0 
                            ? $"rgba(34, 197, 94, {absCorrelation})" // Green for positive
                            : $"rgba(239, 68, 68, {absCorrelation})"; // Red for negative

                        <div class="relative group cursor-pointer p-1 rounded hover:ring-2 hover:ring-blue-500/50 transition-all"
                             style="background-color: @bgColor; min-height: 24px;"
                             title="@($"{rowName} â†” {colKey}: {correlation:F3}")">
                            <div class="absolute inset-0 flex items-center justify-center text-[8px] font-mono text-white/80 opacity-0 group-hover:opacity-100 transition-opacity">
                                @correlation.ToString("P2")
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public CorrelationMatrixDto? CorrelationData { get; set; }
}
